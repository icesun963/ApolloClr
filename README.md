# IL VM的一个 C# 实现

>just for fun!
>

### 导言
>ILDASM 反编译 DLL/EXE 到IL，然后通过构造一个.NET虚拟机，并进行运行。
>并且有很酷的Js版本。

### 提示
>早期版本

### 实现列表

    1.运行堆栈模拟
    2.通过SilAPI对IL进行解析
    3.基础函数方法和类型转换
    4.基础Clr穿透调用，ILVM调用C#，C#调用ILVM
    5.基础类实现，调用字段/静态字段
    6.基础类型转换
    7.基础跳转比较以及流程控制
    8.早期的异常支持，try catch finaly
    9.数组指令的实现
    10.值类型传递，地址传递
   

### 未来的计划支持列表
    1.ref/out 参数支持
    2.单向inteface 支持（需要对dll进行处理）
    3.单向继承（支持继承本地DLL）
    4.反射支持（原生反射不一定好使，扩展反射）
    5.调试器（已经有个早期的版本）
    6.内置的DLL读取，无依赖ildasm
    7.多线程
    8.委托支持
    9.泛型支持
    

### 不支持列表
    1.指针
    2.非托管DLL调用
    3.DllImport
    4.调用堆栈（可使用替换堆栈）

### 实现设计

#### 类和值类型设计
    在IL层，除了地址就是地址，刚开始采用字典实现了一个比较简陋版本的类实现。
    但是在处理结构的时候遇到了麻烦，需要传递不少地址，以及对地址上的值进行操作。
    虽然可以直接写上一段，暂时不支持值类型。对象引用传递还是多少没有问题的。
    这里尝试重新定义数据结构，使用一个类以及一个数组在描述关于内部字段。
    通过预编译，把对字段的描述改变成对数组的访问，可以通过传递对象引用和索引位置，
    来模拟地址操作，RefPtr 这样的一个类型定义。
    StackItem的指向的话，采用IntPtr来处理，本质上是void*，但是Void*不能转换成Object。
    来存储和传递，回头再优化，可以省掉这么一层传递。
    
#### 本地inteface/继承设计
    对本地DLL进行包装，对可继承的所有类/接口，生成一个空的代理类。
    在代理类中插入IL代码实现，在完成整个本地DLL来调用IL代码的过程。

#### 反射支持
    由于并不能改写系统类，只能通过代理类来进行替换传统的读写操作。
    才能达到反射IL类的目的。

### web版本

这里通过Bridge.Net顺便移植了一个早期的版本。
仅仅能运行一些比较早期的代码，不过后续应该还会继续更近。

[运行.NetIL在Web上](http://cdn.rawgit.com/icesun963/ApolloClr/b57c8755/Bridge/www/demo.html)

